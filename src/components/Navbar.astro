---
import Hamburger from "./Hamburger.astro";
import ModeToggle from "./ModeToggle.astro";

const navLinks = [
  ["Home", "/"],
  ["Wiki", "/wiki"],
  ["Blog", "/blog"],
  ["Fiction", "/fiction"],
  ["Poetry", "/poetry"],
  ["Projects", "/projects"],
  ["Partners", "/partners"],
  ["About", "/about"],
];
---

<!-- ===================================
     HEADER â€” Main Navigation Bar
     =================================== -->
<header
  class="fixed top-3 inset-x-0 z-50 text-neutral-700 dark:text-white  font-medium tracking-tight transition-all duration-500 ease-in-out select-none"
>
  <div
    class="mx-auto flex items-center justify-between gap-2 px-[clamp(1rem,3vw,2.5rem)]
           pointer-events-auto transition-all duration-500 ease-in-out w-full"
  >
    <!-- Brand -->
    <a
      href="/"
      class="flex items-center justify-center h-[3.1rem]
             px-[clamp(0.9rem,1.2vw,1.2rem)] rounded-full
             backdrop-blur-xl shadow-lg 
             hover:bg-white/30 dark:hover:bg-black/30 transition-all duration-300 ease-out shrink-0"
    >
      <span class="font-semibold text-[clamp(1.08rem,1.35vw,1.45rem)] whitespace-nowrap hover:scale-105 duration-500 ">
        Coughy.net
      </span>
    </a>

    <!-- Nav Links -->
    <nav
      class="relative flex items-center justify-center h-[3.1rem]
             px-[clamp(0.6rem,1.5vw,1.5rem)] flex-1 mx-auto
             max-w-[900px] rounded-full 
             bg-[rgba(250,250,250,0.15)]  hover:bg-white/30 dark:hover:bg-black/30
              backdrop-blur-xl shadow-lg shadow-black/10
              transition-all duration-300 ease-in-out
             min-w-0 overflow-hidden "
      aria-label="Main Navigation"
    >
        
      <ul
        class="flex justify-center items-center flex-nowrap
               gap-[clamp(0.3rem,1.2vw,2rem)] list-none m-0 p-0"
      >
        {navLinks.map(([label, href]) => (
          <li class="shrink">
            <a
              href={href}
              class="relative inline-block px-[clamp(0.4rem,0.8vw,0.8rem)] py-1
                     text-neutral/700 hover:text-white transition-all duration-300 ease-out
                     after:absolute after:left-1/2 after:-bottom-1 after:w-0 after:h-0.5
                     after:rounded-full after:bg-linear-to-r after:from-blue-400 after:to-purple-400 
                     after:transition-all after:duration-400 after:ease-out
                     hover:after:w-2/3 hover:after:-translate-x-1/2 hover:scale-125"
            >
              {label}
            </a>
          </li>
        ))}
      </ul>
    </nav>

    <!-- Phantom Spacer -->
    <div aria-hidden="true" class="h-[3.1rem] w-[min(8rem,15vw)] shrink-0"></div>
  </div>
</header>
<style is:global>
  #utility-bg.fade-out {
    opacity: 0;
  }

  #utility-bg.expanded {
    width: 5rem;
     transform: translateX(-5rem) scale(0.9)
  }

  #mode-wrapper.shift-left {
    will-change: transform;
  }

  @media (max-width: 600px) {
    #utility-bar {
      right: 1rem;
    }
  }

  /* ðŸŒ™ Fade out middle navbar on small screens */
  @media (max-width: 768px) {
    header nav {
      opacity: 0;
      transform: scale(0.9);
      pointer-events: none;
    }
  }

@media (min-width: 769px) {
  header nav {
    transition: opacity 0.4s ease, transform 0.4s ease, background-color 0.3s ease-in-out;
    /* Add background-color here â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘ */
  }
}
/* ðŸŒ™ Fade out middle navbar on small screens */
@media (max-width: 768px) {
  header nav {
    opacity: 0;
    transform: scale(0.9);
    pointer-events: none;
    /* Add this to disable tab navigation */
    visibility: hidden;
  }
  
  /* Also disable the individual links */
  header nav a {
    visibility: hidden;
  }
}
/* Sidebar closed - not tabbable */
#sidebar-overlay.translate-x-full {
  pointer-events: none;
}

/* Sidebar open - tabbable */
#sidebar-overlay.translate-x-0 {
  pointer-events: auto;
}
</style>

<!-- ===================================
     UTILITY BAR â€” pixel-perfect alignment with sidebar edge
     =================================== -->
<div
  id="utility-bar"
  class="fixed top-3 right-8 z-58 rounded-full 
         flex items-center justify-center h-[3.1rem]
         transition-all duration-500 ease-in-out group"
>
  <!-- Capsule background with group hover -->
  <div
    id="utility-bg"
    class="absolute left-1/2 -translate-x-1/2 rounded-full
           bg-white/10 group-hover:bg-white/30 dark:group-hover:bg-black/30
           backdrop-blur-xl shadow-lg shadow-black/10
           transition-all duration-200 ease-in-out
           opacity-100 w-32 h-full z-60"
  ></div>

  <!-- Icons -->
  <div
    id="utility-content" 
    class="relative z-70 flex items-center gap-2 px-4
           transition-all duration-500 ease-in-out"
  >
    <div id="mode-wrapper" class="transition-transform duration-500 ease-in-out">
      <ModeToggle />
    </div>
    <div id="menu-wrapper">
      <Hamburger />
    </div>
  </div>
</div>






<!-- ===================================
     SIDEBAR + BACKDROP
     =================================== -->
  <div
    id="sidebar-backdrop"
    class="fixed inset-0 bg-black/40 backdrop-blur-md opacity-0 pointer-events-none
           transition-opacity duration-500 z-55"
  >
  <aside
    id="sidebar-overlay"
    class="select-none absolute top-0 right-0 w-[min(80vw,300px)] h-full bg-white/10 dark:bg-black/40
           border-l border-white/20 backdrop-blur-2xl backdrop-saturate-150 shadow-xl
           flex flex-col items-center justify-center gap-6 text-white text-lg font-medium
           transform translate-x-full transition-transform duration-500 z-60"
    inert
    aria-hidden="true"
  >
    <ul class="flex flex-col gap-6 list-none m-0 p-0">
      {navLinks.map(([label, href]) => (
        <li>
          <a href={href} class="hover:text-blue-300 transition">
            {label}
          </a>
        </li>
      ))}
    </ul>
  </aside>

<!-- ===================================
     SCRIPT â€” Sidebar Logic
     =================================== -->
<script is:inline>
document.addEventListener("DOMContentLoaded", () => {
  const hamburger =
    document.querySelector("button[aria-label='Menu']") ||
    document.querySelector("button[aria-label='Toggle menu']") ||
    document.querySelector("#hamburger") ||
    document.querySelector(".hamburger-btn");

  const sidebar = document.getElementById("sidebar-overlay");
  const backdrop = document.getElementById("sidebar-backdrop");
  const utilityBg = document.getElementById("utility-bg");
  const modeWrapper = document.getElementById("mode-wrapper");

  if (!(hamburger && sidebar && backdrop && utilityBg && modeWrapper)) {
    console.warn("[Navbar] Missing elements!");
    return;
  }

  const computeShift = () => {
    const sidebarWidth = sidebar.offsetWidth || 300; // fixed fallback
    // Move the toggle roughly the same distance as sidebar width minus a little buffer
    // so that the toggle aligns visually with the sidebar's inner edge
    const shiftDistance = -(sidebarWidth / 2.4); // tweak multiplier for balance
    return shiftDistance;
  };

const openSidebar = () => {
  sidebar.classList.remove("translate-x-full");
  sidebar.classList.add("translate-x-0");
  backdrop.classList.remove("opacity-0", "pointer-events-none");
  utilityBg.classList.add("fade-out", "expanded");
  
  // Remove inert attribute to make tabbable
  sidebar.removeAttribute("inert");
  sidebar.setAttribute("aria-hidden", "false");
  
  const shift = computeShift();
  modeWrapper.style.transform = `translateX(${shift}px)`;
  
  // Focus first link after transition
  setTimeout(() => {
    const firstLink = sidebar.querySelector('a');
    if (firstLink) {
      firstLink.focus();
      console.log('Focused first link:', firstLink); // Debug
    }
  }, 300);
};

const closeSidebar = () => {
  sidebar.classList.add("translate-x-full");
  sidebar.classList.remove("translate-x-0");
  backdrop.classList.add("opacity-0", "pointer-events-none");
  utilityBg.classList.remove("fade-out", "expanded");
  
  // Add inert attribute to remove from tab order
  sidebar.setAttribute("inert", "");
  sidebar.setAttribute("aria-hidden", "true");
  modeWrapper.style.transform = "";
};

  hamburger.addEventListener("click", (e) => {
    e.stopPropagation();
    const isOpen = sidebar.classList.contains("translate-x-0");
    isOpen ? closeSidebar("hamburger") : openSidebar();
  });

  backdrop.addEventListener("click", (e) => {
    if (e.target === backdrop) closeSidebar("backdrop");
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeSidebar("ESC");
  });

  window.addEventListener("resize", () => {
    if (sidebar.classList.contains("translate-x-0")) {
      const shift = computeShift();
      modeWrapper.style.transform = `translateX(${shift}px)`;
    }
  });
});


</script>

