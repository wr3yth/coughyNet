---
import Hamburger from "./Hamburger.astro";
import ModeToggle from "./ModeToggle.astro";

const navLinks = [
  ["Home", "/"],
  ["Wiki", "/wiki"],
  ["Blog", "/blog"],
  ["Fiction", "/fiction"],
  ["Poetry", "/poetry"],
  ["Projects", "/projects"],
  ["Partners", "/partners"],
  ["About", "/about"],
];
---

<Fragment slot="head">
  <script is:inline>
    const saved = localStorage.getItem("theme");
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    const isDark = saved === "dark" || (!saved && prefersDark);

    if (isDark) document.documentElement.classList.add("dark");

    const css = `
      #icon-sun {
        opacity: ${isDark ? "1" : "0"};
        transform: ${isDark ? "scale(1) rotate(0deg)" : "scale(0.5) rotate(90deg)"};
      }
      #icon-moon {
        opacity: ${isDark ? "0" : "1"};
        transform: ${isDark ? "scale(0.5) rotate(-90deg)" : "scale(1) rotate(0deg)"};
      }
    `;
    const styleTag = document.createElement("style");
    styleTag.innerHTML = css;
    document.head.appendChild(styleTag);
  </script>
</Fragment>

<header
  class="fixed top-3 inset-x-0 z-50 text-neutral-700 dark:text-white font-medium tracking-tight transition-all duration-500 ease-in-out select-none"
>
  <div
    class="mx-auto flex items-center justify-between gap-2 px-[clamp(1rem,3vw,2.5rem)]
           pointer-events-auto transition-all duration-500 ease-in-out w-full"
  >
    <a
      href="/"
      class="flex items-center justify-center h-[3.1rem]
             px-[clamp(0.9rem,1.2vw,1.2rem)] rounded-full
             backdrop-blur-xl shadow-lg 
             hover:bg-white/30 dark:hover:bg-black/30 transition-all duration-300 ease-out shrink-0"
    >
      <span class="font-semibold text-[clamp(1.08rem,1.35vw,1.45rem)] whitespace-nowrap hover:scale-105 duration-500">
        Coughy.net
      </span>
    </a>

    <nav
      class="relative flex items-center justify-center h-[3.1rem]
             px-[clamp(0.6rem,1.5vw,1.5rem)] flex-1 mx-auto
             max-w-[900px] rounded-full 
             bg-[rgba(250,250,250,0.15)] hover:bg-white/30 dark:hover:bg-black/30
             backdrop-blur-xl shadow-lg shadow-black/10
             transition-all duration-300 ease-in-out
             min-w-0 overflow-hidden"
      aria-label="Main Navigation"
    >
      <ul
        class="flex justify-center items-center flex-nowrap
               gap-[clamp(0.3rem,1.2vw,2rem)] list-none m-0 p-0"
      >
        {navLinks.map(([label, href]) => (
          <li class="shrink">
            <a
              href={href}
              class="relative inline-block px-[clamp(0.4rem,0.8vw,0.8rem)] py-1
                     text-neutral-700 dark:text-white hover:text-white transition-all duration-300 ease-out
                     after:absolute after:left-1/2 after:-bottom-1 after:w-0 after:h-0.5
                     after:rounded-full after:bg-linear-to-r after:from-blue-400 after:to-purple-400 
                     after:transition-all after:duration-400 after:ease-out
                     hover:after:w-2/3 hover:after:-translate-x-1/2 hover:scale-125"
            >
              {label}
            </a>
          </li>
        ))}
      </ul>
    </nav>

    <div aria-hidden="true" class="h-[3.1rem] w-[min(8rem,15vw)] shrink-0"></div>
  </div>
</header>

<style is:global>
  #utility-bg.fade-out {
    opacity: 0;
  }

  #utility-bg.expanded {
    width: 5rem;
    transform: translateX(-5rem) scale(0.9);
  }

  #mode-wrapper.shift-left {
    will-change: transform;
  }

  @media (max-width: 600px) {
    #utility-bar {
      right: 1rem;
    }
  }

  @media (max-width: 768px) {
    header nav {
      opacity: 0;
      transform: scale(0.9);
      pointer-events: none;
      visibility: hidden;
    }

    header nav a {
      visibility: hidden;
    }
  }

  @media (min-width: 769px) {
    header nav {
      transition: opacity 0.4s ease, transform 0.4s ease, background-color 0.3s ease-in-out;
    }
  }

  #sidebar-overlay.translate-x-full {
    pointer-events: none;
  }

  #sidebar-overlay.translate-x-0 {
    pointer-events: auto;
  }
</style>

<div
  id="utility-bar"
  class="fixed top-3 right-8 z-58 rounded-full 
         flex items-center justify-center h-[3.1rem]
         transition-all duration-500 ease-in-out group"
>
  <div
    id="utility-bg"
    class="absolute left-1/2 -translate-x-1/2 rounded-full
           bg-white/10 group-hover:bg-white/30 dark:group-hover:bg-black/30
           backdrop-blur-xl shadow-lg shadow-black/10
           transition-all duration-200 ease-in-out
           opacity-100 w-32 h-full z-60"
  ></div>

  <div
    id="utility-content" 
    class="relative z-70 flex items-center gap-2 px-4
           transition-all duration-500 ease-in-out"
  >
    <div id="mode-wrapper" class="transition-transform duration-500 ease-in-out">
      <ModeToggle />
    </div>
    <div id="menu-wrapper">
      <Hamburger />
    </div>
  </div>
</div>

<div
  id="social"
  class="fixed bottom-4 left-1/2 -translate-x-1/2 z-70
         flex items-center justify-center gap-4 px-5 py-2
         bg-white/10 backdrop-blur-lg hover:bg-white/30 dark:hover:bg-white/5
         transition-all duration-500 ease-in-out
         rounded-xl shadow-md text-sm w-fit"
>
  <!-- Twitter -->
  <a
    href="https://twitter.com/coughman8"
    target="_blank"
    class="text-white dark:text-white hover:text-blue-400 transition-all duration-300 hover:scale-150"
    aria-label="Twitter"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="currentColor"
    >
      <path d="M14.058 3.41c-1.807 .767 -2.995 2.453 -3.056 4.38l-.002 .182l-.243 -.023c-2.392 -.269 -4.498 -1.512 -5.944 -3.531a1 1 0 0 0 -1.685 .092l-.097 .186l-.049 .099c-.719 1.485 -1.19 3.29 -1.017 5.203l.03 .273c.283 2.263 1.5 4.215 3.779 5.679l.173 .107l-.081 .043c-1.315 .663 -2.518 .952 -3.827 .9c-1.056 -.04 -1.446 1.372 -.518 1.878c3.598 1.961 7.461 2.566 10.792 1.6c4.06 -1.18 7.152 -4.223 8.335 -8.433l.127 -.495c.238 -.993 .372 -2.006 .401 -3.024l.003 -.332l.393 -.779l.44 -.862l.214 -.434l.118 -.247c.265 -.565 .456 -1.033 .574 -1.43l.014 -.056l.008 -.018c.22 -.593 -.166 -1.358 -.941 -1.358l-.122 .007a.997 .997 0 0 0 -.231 .057l-.086 .038a7.46 7.46 0 0 1 -.88 .36l-.356 .115l-.271 .08l-.772 .214c-1.336 -1.118 -3.144 -1.254 -5.012 -.554l-.211 .084z" />
    </svg>
  </a>

  <!-- GitHub -->
  <a
    href="https://github.com/wr3yth"
    target="_blank"
    class="text-white dark:text-white hover:text-gray-600 transition-all duration-300 hover:scale-150"
    aria-label="GitHub"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="currentColor"
    >
      <path d="M5.315 2.1c.791 -.113 1.9 .145 3.333 .966l.272 .161l.16 .1l.397 -.083a13.3 13.3 0 0 1 4.59 -.08l.456 .08l.396 .083l.161 -.1c1.385 -.84 2.487 -1.17 3.322 -1.148l.164 .008l.147 .017l.076 .014l.05 .011l.144 .047a1 1 0 0 1 .53 .514a5.2 5.2 0 0 1 .397 2.91l-.047 .267l-.046 .196l.123 .163c.574 .795 .93 1.728 1.03 2.707l.023 .295l.007 .272c0 3.855 -1.659 5.883 -4.644 6.68l-.245 .061l-.132 .029l.014 .161l.008 .157l.004 .365l-.002 .213l-.003 3.834a1 1 0 0 1 -.883 .993l-.117 .007h-6a1 1 0 0 1 -.993 -.883l-.007 -.117v-.734c-1.818 .26 -3.03 -.424 -4.11 -1.878l-.535 -.766c-.28 -.396 -.455 -.579 -.589 -.644l-.048 -.019a1 1 0 0 1 .564 -1.918c.642 .188 1.074 .568 1.57 1.239l.538 .769c.76 1.079 1.36 1.459 2.609 1.191l.001 -.678l-.018 -.168a5.03 5.03 0 0 1 -.021 -.824l.017 -.185l.019 -.12l-.108 -.024c-2.976 -.71 -4.703 -2.573 -4.875 -6.139l-.01 -.31l-.004 -.292a5.6 5.6 0 0 1 .908 -3.051l.152 -.222l.122 -.163l-.045 -.196a5.2 5.2 0 0 1 .145 -2.642l.1 -.282l.106 -.253a1 1 0 0 1 .529 -.514l.144 -.047l.154 -.03z" />
    </svg>
  </a>

  <!-- YouTube -->
  <a
    href="https://youtube.com/coughynist"
    target="_blank"
    class="text-white dark:text-white hover:text-red-500 transition-all duration-300 hover:scale-150"
    aria-label="YouTube"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="currentColor"
    >
      <path d="M18 3a5 5 0 0 1 5 5v8a5 5 0 0 1 -5 5h-12a5 5 0 0 1 -5 -5v-8a5 5 0 0 1 5 -5zm-9 6v6a1 1 0 0 0 1.514 .857l5 -3a1 1 0 0 0 0 -1.714l-5 -3a1 1 0 0 0 -1.514 .857z" />
    </svg>
    <!-- Telegram -->
    <a
      href="https://t.me/gardanravan"
      target="_blank"
      class="text-white dark:text-white hover:text-blue-400 transition-all duration-300 hover:scale-150"
      aria-label="Telegram"
    >
      <svg 
        width="24px" 
        height="24px" 
        version="1.1" 
        xmlns="http://www.w3.org/2000/svg" 
        xmlns:xlink="http://www.w3.org/1999/xlink" 
        xml:space="preserve" 
        xmlns:serif="http://www.serif.com/" 
        style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;"
      >
        <path 
          d="M18.384,22.779c0.322,0.228 0.737,0.285 1.107,0.145c0.37,-0.141 0.642,-0.457 0.724,-0.84c0.869,-4.084 2.977,-14.421 3.768,-18.136c0.06,-0.28 -0.04,-0.571 -0.26,-0.758c-0.22,-0.187 -0.525,-0.241 -0.797,-0.14c-4.193,1.552 -17.106,6.397 -22.384,8.35c-0.335,0.124 -0.553,0.446 -0.542,0.799c0.012,0.354 0.25,0.661 0.593,0.764c2.367,0.708 5.474,1.693 5.474,1.693c0,0 1.452,4.385 2.209,6.615c0.095,0.28 0.314,0.5 0.603,0.576c0.288,0.075 0.596,-0.004 0.811,-0.207c1.216,-1.148 3.096,-2.923 3.096,-2.923c0,0 3.572,2.619 5.598,4.062Zm-11.01,-8.677l1.679,5.538l0.373,-3.507c0,0 6.487,-5.851 10.185,-9.186c0.108,-0.098 0.123,-0.262 0.033,-0.377c-0.089,-0.115 -0.253,-0.142 -0.376,-0.064c-4.286,2.737 -11.894,7.596 -11.894,7.596Z"
          fill="currentColor"
        />
      </svg>
    </a>
  <!-- Instagram -->
  <a
    href="https://instagram.com/pdc.ali"
    target="_blank"
    class="group text-white dark:text-white transition-all duration-300 hover:scale-150"
    aria-label="Instagram"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      class="fill-current group-hover:fill-[url(#instagram-gradient)]"
    >
      <defs>
        <linearGradient id="instagram-gradient" x1="100%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#833ab4" />
          <stop offset="50%" stop-color="#fd1d1d" />
          <stop offset="100%" stop-color="#fcb045" />
        </linearGradient>
      </defs>
      <path d="M16 3a5 5 0 0 1 5 5v8a5 5 0 0 1 -5 5h-8a5 5 0 0 1 -5 -5v-8a5 5 0 0 1 5 -5zm-4 5a4 4 0 0 0 -3.995 3.8l-.005 .2a4 4 0 1 0 4 -4m4.5 -1.5a1 1 0 0 0 -.993 .883l-.007 .127a1 1 0 0 0 1.993 .117l.007 -.127a1 1 0 0 0 -1 -1" />
    </svg>
  </a>
</div>

<!-- ===================================
     SIDEBAR + BACKDROP
     =================================== -->
<div
  id="sidebar-backdrop"
  class="fixed inset-0 bg-black/40 backdrop-blur-md opacity-0 pointer-events-none
         transition-opacity duration-500 z-55"
>
  <aside
    id="sidebar-overlay"
    class="select-none absolute top-0 right-0 w-[min(80vw,300px)] h-full bg-white/10 dark:bg-black/40
           border-l border-white/20 backdrop-blur-2xl backdrop-saturate-150 shadow-xl
           flex flex-col items-center justify-center gap-6 text-white text-lg font-medium
           transform translate-x-full transition-transform duration-500 z-60"
    inert
    aria-hidden="true"
  >
    <ul class="flex flex-col gap-6 list-none m-0 p-0">
      {navLinks.map(([label, href]) => (
        <li>
          <a href={href} class="hover:text-blue-300 transition">
            {label}
          </a>
        </li>
      ))}
    </ul>
  </aside>
</div>

<!-- ===================================
     SCRIPT — Sidebar Logic
     =================================== -->
<script is:inline>
document.addEventListener("DOMContentLoaded", () => {
  const hamburger =
    document.querySelector("button[aria-label='Menu']") ||
    document.querySelector("button[aria-label='Toggle menu']") ||
    document.querySelector("#hamburger") ||
    document.querySelector(".hamburger-btn");

  const sidebar = document.getElementById("sidebar-overlay");
  const backdrop = document.getElementById("sidebar-backdrop");
  const utilityBg = document.getElementById("utility-bg");
  const modeWrapper = document.getElementById("mode-wrapper");
  const social = document.getElementById("social");

  if (!(hamburger && sidebar && backdrop && utilityBg && modeWrapper && social)) {
    console.warn("[Navbar] Missing elements!");
    return;
  }

  const computeShift = () => {
    const sidebarWidth = sidebar.offsetWidth || 300;
    return -(sidebarWidth / 2.4);
  };

  // ⬇️ Move ONLY horizontally, relative to current transform
  const moveSocialToSidebarCenter = () => {
    const socialRect = social.getBoundingClientRect();
    const sidebarRect = sidebar.getBoundingClientRect();

    const socialCenterX = socialRect.left + socialRect.width / 2;
    const sidebarCenterX = sidebarRect.left + sidebarRect.width / 2;

    const deltaX = sidebarCenterX - socialCenterX;

    const baseTransform = getComputedStyle(social).transform;
    const base = baseTransform === "none" ? "" : baseTransform;

    social.style.transform = `${base} translateX(${deltaX}px)`;
  };

  const resetSocialPosition = () => {
    social.style.transform = "";
  };

  const openSidebar = () => {
    sidebar.classList.remove("translate-x-full");
    sidebar.classList.add("translate-x-0");
    backdrop.classList.remove("opacity-0", "pointer-events-none");
    utilityBg.classList.add("fade-out", "expanded");

    sidebar.removeAttribute("inert");
    sidebar.setAttribute("aria-hidden", "false");

    const shift = computeShift();
    modeWrapper.style.transform = `translateX(${shift}px)`;

    // Small timeout so sidebar has layout before measuring
    setTimeout(() => {
      moveSocialToSidebarCenter();
    }, 400);

    setTimeout(() => {
      const firstLink = sidebar.querySelector("a");
      if (firstLink) firstLink.focus();
    }, 300);
  };

  const closeSidebar = () => {
    sidebar.classList.add("translate-x-full");
    sidebar.classList.remove("translate-x-0");
    backdrop.classList.add("opacity-0", "pointer-events-none");
    utilityBg.classList.remove("fade-out", "expanded");

    sidebar.setAttribute("inert", "");
    sidebar.setAttribute("aria-hidden", "true");
    modeWrapper.style.transform = "";

    resetSocialPosition();
  };

  hamburger.addEventListener("click", (e) => {
    e.stopPropagation();
    const isOpen = sidebar.classList.contains("translate-x-0");
    isOpen ? closeSidebar("hamburger") : openSidebar();
  });

  backdrop.addEventListener("click", (e) => {
    if (e.target === backdrop) closeSidebar("backdrop");
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeSidebar("ESC");
  });

  window.addEventListener("resize", () => {
    if (sidebar.classList.contains("translate-x-0")) {
      const shift = computeShift();
      modeWrapper.style.transform = `translateX(${shift}px)`;
      moveSocialToSidebarCenter();
    }
  });
});
</script>
